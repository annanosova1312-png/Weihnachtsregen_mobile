<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Weihnachtsregen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; margin: 0; padding: 0; }
    html, body {
      height: 100%;
      overflow: hidden;
      font-family: 'Nunito', sans-serif;
      background: url('zimnii_risunok.jpg') center/cover no-repeat fixed;
      touch-action: none;
    }

    h1 {
      text-align: center;
      color: white;
      font-family: 'Baloo 2', cursive;
      font-size: clamp(24px, 5vw, 40px);
      text-shadow: 0 0 10px #ffd700;
      margin: 6px 0 4px;
    }

    .hud {
      text-align: center;
      color: white;
      font-size: clamp(16px, 4vw, 20px);
      margin-bottom: 6px;
    }

    #gameContainer {
      position: relative;
      width: 100vw;
      height: calc(100vh - 70px);
      max-width: 900px;
      max-height: 550px;
      margin: 0 auto;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }

    #logo {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 120px;
      z-index: 2;
      pointer-events: none;
    }

    /* –û–≤–µ—Ä–ª–µ–∏ */
    .overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }
    .hidden { display: none !important; }

    .start-box, .quiz-box, .end-box {
      background: #024;
      padding: 25px;
      border-radius: 20px;
      color: white;
      text-align: center;
      width: 85%;
      max-width: 550px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }

    .quiz-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 15px;
    }
    .quiz-card {
      border: 2px solid white;
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.2);
      font-size: 16px;
      cursor: pointer;
    }

    button {
      padding: 14px 24px;
      font-size: 20px;
      border-radius: 14px;
      border: none;
      background: #ffd700;
      color: #024;
      font-weight: bold;
      margin-top: 15px;
      cursor: pointer;
    }

    #snow {
      position: absolute;
      top: 0; left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1;
    }
  </style>
</head>
<body>
  <audio id="bgMusic" src="Jingle_bells.mp3" loop></audio>

  <h1>Weihnachtsregen üéÑ</h1>
  <div class="hud">
    Punkte: <span id="score">0</span> ‚Ä¢ Verpasst: <span id="misses">0</span>/3 ‚Ä¢ Fragen: <span id="quiz-progress">0</span>/10
  </div>

  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <img id="logo" src="frau_anna.png" alt="Frau Anna Logo">
    <canvas id="snow"></canvas>

    <!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ –æ–≤–µ—Ä–ª–µ–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–æ–Ω–∏ –ø–æ–≤–µ—Ä—Ö canvas) -->
    <div id="quizOverlay" class="overlay hidden">
      <div class="quiz-box">
        <h2 id="quizTitle">Wo ist ...?</h2>
        <div class="quiz-grid" id="quizOptions"></div>
      </div>
    </div>

    <div id="gameOverOverlay" class="overlay hidden">
      <div class="end-box">
        <h2>Spiel vorbei!</h2>
        <p>Dein Punktestand: <span id="finalScore">0</span></p>
        <button onclick="restartGame()">Nochmal spielen</button>
      </div>
    </div>

    <div id="congratsOverlay" class="overlay hidden">
      <div class="end-box" style="position:relative;">
        <button onclick="restartGame()" style="position:absolute; top:10px; right:15px; background:none; border:none; color:white; font-size:24px;">‚úñ</button>
        <h2 style="font-size:28px; color:#fff;">Hurra! üéâ</h2>
        <p style="font-size:20px; color:#ffdd55;">Du hast alle 10 Fragen geschafft!</p>
        <button onclick="restartGame()">Nochmal spielen</button>
      </div>
    </div>
  </div>

  <!-- –°–¢–ê–†–¢–û–í–û–ï –û–ö–ù–û ‚Äî –í–ù–ï –ö–û–ù–¢–ï–ô–ù–ï–†–ê, –ü–û–õ–ù–û–°–¢–¨–Æ –ü–û–í–ï–†–• –í–°–ï–ì–û -->
  <div id="startOverlay" class="overlay">
    <div class="start-box">
      <h2 style="font-family:'Baloo 2'; font-size:28px; margin-top:0;">Weihnachtsregen üéÅ</h2>
      <p style="font-size:18px;">Fang die fallenden Weihnachtsobjekte!</p>
      <button id="startButton">Start</button>
    </div>
  </div>

<script>
// === –û–°–ù–û–í–ù–´–ï –ù–ê–°–¢–†–û–ô–ö–ò ===
const bgMusic = document.getElementById("bgMusic");
bgMusic.volume = 0.15;

const itemDefinitions = [
  { key:'die_kerze', article:'die', word:'Kerze' },
  { key:'die_glocke', article:'die', word:'Glocke' },
  { key:'der_stern', article:'der', word:'Stern' },
  { key:'die_schneeflocke', article:'die', word:'Schneeflocke' },
  { key:'der_schnee', article:'der', word:'Schnee' },
  { key:'der_weihnachtsbaum', article:'der', word:'Weihnachtsbaum' },
  { key:'das_rendtier', article:'das', word:'Rentier' },
  { key:'der_engel', article:'der', word:'Engel' },
  { key:'der_elf', article:'der', word:'Elf' },
  { key:'der_nikolaus', article:'der', word:'Nikolaus' },
  { key:'der_apfel', article:'der', word:'Apfel' },
  { key:'die_schokolade', article:'die', word:'Schokolade' },
  { key:'die_nuss', article:'die', word:'Nuss' },
  { key:'die_mandarine', article:'die', word:'Mandarine' },
  { key:'das_bonbon', article:'das', word:'Bonbon' },
  { key:'der_schneemann', article:'der', word:'Schneemann' },
  { key:'der_schlitten', article:'der', word:'Schlitten' },
  { key:'die_kugel', article:'die', word:'Kugel' },
  { key:'die_lichter', article:'die', word:'Lichter' },
  { key:'das_geschenk', article:'das', word:'Geschenk' },
  { key:'der_adventskranz', article:'der', word:'Adventskranz' },
  { key:'der_weihnachtsmann', article:'der', word:'Weihnachtsmann' }
];

const TOTAL_QUESTIONS = 10;
const canvas = document.getElementById("gameCanvas");
const snowCanvas = document.getElementById("snow");
const container = document.getElementById("gameContainer");

// –†–∞–∑–º–µ—Ä—ã –ª–æ–≥–∏—á–µ—Å–∫–æ–π —Å—Ü–µ–Ω—ã
const GAME_WIDTH = 900;
const GAME_HEIGHT = 550;
let scaleX = 1, scaleY = 1;

function resizeCanvas() {
  const w = container.clientWidth;
  const h = container.clientHeight;
  canvas.width = w;
  canvas.height = h;
  snowCanvas.width = w;
  snowCanvas.height = h;
  scaleX = w / GAME_WIDTH;
  scaleY = h / GAME_HEIGHT;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

const ctx = canvas.getContext("2d");
const snowCtx = snowCanvas.getContext("2d");

let score = 0, misses = 0, caught = 0;
let items = [];
let spawnTimer = 0;
let gameActive = false;
let inQuiz = false;
let lastTime = 0;

let sack = { x: 400, y: 470, width: 100, height: 80, speed: 400 };

let remainingQuestions = [];
let currentQuestion = null;
let attempts = 0;
let answered = 0;

// === –ó–ê–ì–†–£–ó–ö–ê –ê–°–°–ï–¢–û–í ===
const images = {}, audios = {};
function loadAssets() {
  images['sack'] = new Image(); images['sack'].src = 'sack.png';
  itemDefinitions.forEach(i => {
    images[i.key] = new Image();
    images[i.key].src = i.key + '.png';
  });
  audios['ja'] = new Audio('ja.wav');
  audios['nein'] = new Audio('nein.wav');
  itemDefinitions.forEach(i => {
    audios[i.key] = new Audio(i.key + '.wav');
  });
}
loadAssets();

// === –£–ü–†–ê–í–õ–ï–ù–ò–ï ===
let isTouching = false;
canvas.addEventListener("pointerdown", e => {
  isTouching = true;
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) / scaleX;
  sack.x = x - sack.width / 2;
});
canvas.addEventListener("pointermove", e => {
  if (!isTouching) return;
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) / scaleX;
  sack.x = x - sack.width / 2;
});
["pointerup", "pointercancel"].forEach(ev => {
  canvas.addEventListener(ev, () => isTouching = false);
});

// === –°–¢–ê–†–¢ ===
document.getElementById("startButton").addEventListener("click", () => {
  document.getElementById("startOverlay").classList.add("hidden");
  bgMusic.play().catch(() => {});
  gameActive = true;
});

// === –°–ù–ï–ì ===
let snowflakes = Array.from({length: 100}, () => ({
  x: Math.random() * GAME_WIDTH,
  y: Math.random() * GAME_HEIGHT,
  r: Math.random() * 3 + 1,
  speed: Math.random() * 1 + 0.5
}));
function drawSnow() {
  snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
  snowflakes.forEach(f => {
    snowCtx.beginPath();
    snowCtx.arc(f.x * scaleX, f.y * scaleY, f.r, 0, Math.PI * 2);
    snowCtx.fillStyle = "white";
    snowCtx.fill();
    f.y += f.speed;
    if (f.y > GAME_HEIGHT) {
      f.y = -5;
      f.x = Math.random() * GAME_WIDTH;
    }
  });
}

// === –ö–í–ò–ó ===
function startQuiz() {
  inQuiz = true;
  currentQuestion = remainingQuestions.shift();
  attempts = 0;
  const titleEl = document.getElementById("quizTitle");
  if (currentQuestion.key === 'die_lichter') {
    titleEl.textContent = 'Wo sind die Lichter?';
  } else {
    titleEl.textContent = `Wo ist ${currentQuestion.article} ${currentQuestion.word}?`;
  }

  const options = [currentQuestion];
  const others = itemDefinitions.filter(i => i.key !== currentQuestion.key);
  shuffle(others);
  options.push(...others.slice(0, 2));
  shuffle(options);

  const box = document.getElementById("quizOptions");
  box.innerHTML = "";
  options.forEach(opt => {
    const el = document.createElement("div");
    el.className = "quiz-card";
    el.dataset.key = opt.key;
    el.innerHTML = `<img src="${opt.key}.png" style="width:100%;"><div>${opt.article} ${opt.word}</div>`;
    box.appendChild(el);
  });

  document.getElementById("quizOverlay").classList.remove("hidden");
  playSound(currentQuestion.key);
}

function playSound(name) {
  const a = audios[name];
  if (a) { a.pause(); a.currentTime = 0; a.play().catch(() => {}); }
}

function stopAllAudio() {
  Object.values(audios).forEach(a => { a.pause(); a.currentTime = 0; });
}

document.getElementById("quizOptions").addEventListener("click", e => {
  const card = e.target.closest('.quiz-card');
  if (!card || !currentQuestion) return;
  const chosen = card.dataset.key;
  if (chosen === currentQuestion.key) {
    score += (attempts === 0 ? 3 : attempts === 1 ? 2 : 1);
    answered++;
    stopAllAudio();
    playSound('ja');
    document.getElementById("quizOverlay").classList.add("hidden");
    inQuiz = false;
    updateHUD();
    if (answered >= TOTAL_QUESTIONS) showCongrats();
  } else {
    attempts++;
    stopAllAudio();
    playSound('nein');
  }
});

// === –ó–ê–í–ï–†–®–ï–ù–ò–ï ===
function endGame() {
  gameActive = false;
  document.getElementById("finalScore").textContent = score;
  document.getElementById("gameOverOverlay").classList.remove("hidden");
}
function showCongrats() {
  document.getElementById("congratsOverlay").classList.remove("hidden");
}
function restartGame() {
  location.reload();
}

// === –ò–ì–†–û–í–û–ô –¶–ò–ö–õ ===
function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function spawnItem() {
  const def = itemDefinitions[Math.floor(Math.random() * itemDefinitions.length)];
  items.push({
    key: def.key,
    x: Math.random() * (GAME_WIDTH - 60),
    y: -60,
    width: 60,
    height: 60,
    speed: 120 + Math.random() * 80
  });
}

function updateHUD() {
  document.getElementById("score").textContent = score;
  document.getElementById("misses").textContent = misses;
  document.getElementById("quiz-progress").textContent = answered;
}

function update(dt) {
  if (!gameActive || inQuiz) return;

  // –ì—Ä–∞–Ω–∏—Ü—ã
  if (sack.x < 0) sack.x = 0;
  if (sack.x + sack.width > GAME_WIDTH) sack.x = GAME_WIDTH - sack.width;

  // –°–ø–∞–≤–Ω
  spawnTimer += dt * 1000;
  if (spawnTimer > 1000) {
    spawnItem();
    spawnTimer = 0;
  }

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
  let remaining = [];
  for (const item of items) {
    item.y += item.speed * dt;
    if (checkCollision(item, sack)) {
      score++; caught++; misses = 0;
      if (caught > 0 && caught % 5 === 0 && remainingQuestions.length > 0) {
        startQuiz();
      }
    } else if (item.y > GAME_HEIGHT + 20) {
      misses++;
      if (misses >= 3) {
        endGame();
        return;
      }
    } else {
      remaining.push(item);
    }
  }
  items = remaining;
  updateHUD();
}

function checkCollision(a, b) {
  return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  items.forEach(item => {
    ctx.drawImage(images[item.key], item.x * scaleX, item.y * scaleY, item.width * scaleX, item.height * scaleY);
  });
  ctx.drawImage(images['sack'], sack.x * scaleX, sack.y * scaleY, sack.width * scaleX, sack.height * scaleY);
  drawSnow();
}

function gameLoop(timestamp) {
  if (!lastTime) lastTime = timestamp;
  const dt = (timestamp - lastTime) / 1000;
  lastTime = timestamp;
  update(dt);
  draw();
  requestAnimationFrame(gameLoop);
}
requestAnimationFrame(gameLoop);

// === –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===
remainingQuestions = shuffle([...itemDefinitions]).slice(0, TOTAL_QUESTIONS);
updateHUD();
</script>
</body>
</html>
