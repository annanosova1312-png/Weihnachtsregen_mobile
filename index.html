<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Weihnachtsregen</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: 'Nunito';
      background: url('zimnii_risunok.jpg') center/cover no-repeat fixed;
      touch-action: none;
    }

    #gameContainer {
      position: relative;
      width: 100vw;
      height: calc(100vh - 80px);
      max-width: 900px;
      max-height: 550px;
      margin: 0 auto;
    }

    canvas {
      display: block;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0);
      position: relative;
      z-index: 1;
    }

    #logo {
      position: absolute;
      top: 10px;
      left: 10px;
      width: 120px;
      z-index: 2;
      pointer-events: none;
    }

    /* –û–±—â–∏–π overlay */
    .overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(0,0,0,0.7);
      z-index: 5;
    }
    .hidden { display: none !important; }

    /* –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –æ–∫–Ω–æ ‚Äî –±–µ–∑ –∑–∞—Ç–µ–º–Ω–µ–Ω–∏—è */
    #startOverlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 6;
      background: none;
    }

    .start-box {
      background: #024;
      padding: 25px;
      border-radius: 20px;
      color: white;
      text-align: center;
      width: 85%;
      max-width: 600px;
      box-shadow: 0 0 20px rgba(0,0,0,0.4);
    }

    .quiz-card {
      cursor: pointer;
      border: 2px solid white;
      border-radius: 12px;
      padding: 10px;
      background: rgba(255,255,255,0.2);
      font-size: 16px;
    }
    .quiz-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
    }

    button {
      padding: 14px 24px;
      font-size: 20px;
      border-radius: 14px;
      cursor: pointer;
      border: none;
      background: #ffd700;
      color: #024;
      font-weight: bold;
      margin-top: 15px;
    }

    h1 {
      text-align: center;
      color: white;
      font-family: 'Baloo 2';
      font-size: clamp(24px, 5vw, 40px);
      text-shadow: 0 0 10px #ffd700;
      margin: 8px 0 0;
    }

    .hud {
      text-align: center;
      color: white;
      margin: 4px 0 6px;
      font-size: clamp(16px, 4vw, 20px);
    }

    #snow {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 3;
    }
  </style>
</head>
<body>
  <audio id="bgMusic" src="Jingle_bells.mp3" loop></audio>

  <h1>Weihnachtsregen üéÑ</h1>
  <div class="hud">
    Punkte: <span id="score">0</span> ‚Ä¢ Verpasst: <span id="misses">0</span>/3 ‚Ä¢ Fragen: <span id="quiz-progress">0</span>/10
  </div>

  <div id="gameContainer">
    <canvas id="gameCanvas"></canvas>
    <img id="logo" src="frau_anna.png" alt="Frau Anna Logo">
    <canvas id="snow"></canvas>

    <!-- –°—Ç–∞—Ä—Ç–æ–≤–æ–µ –æ–∫–Ω–æ -->
    <div id="startOverlay">
      <div class="start-box">
        <h2 style="font-family:'Baloo 2'; font-size:28px; margin-top:0;">Weihnachtsregen üéÅ</h2>
        <p style="font-size:18px;">Fang die fallenden Weihnachtsobjekte!</p>
        <button id="startButton">Start</button>
      </div>
    </div>

    <!-- –ö–≤–∏–∑ -->
    <div id="quizOverlay" class="overlay hidden">
      <div style="background:#153; padding:20px; border-radius:20px; color:white; width:85%; max-width:500px; text-align:center;">
        <h2 id="quizTitle">Wo ist ...?</h2>
        <div class="quiz-grid" id="quizOptions"></div>
      </div>
    </div>

    <!-- Game Over -->
    <div id="gameOverOverlay" class="overlay hidden">
      <div style="background:#300; padding:20px; border-radius:20px; color:white; width:85%; max-width:500px; text-align:center;">
        <h2>Spiel vorbei!</h2>
        <p>Dein Punktestand: <span id="finalScore">0</span></p>
        <button onclick="restartGame()">Nochmal spielen</button>
      </div>
    </div>

    <!-- Congrats -->
    <div id="congratsOverlay" class="overlay hidden">
      <div style="background:#035; padding:20px; border-radius:20px; color:white; width:85%; max-width:500px; text-align:center; position:relative;">
        <button onclick="restartGame()" style="position:absolute; top:10px; right:15px; background:none; border:none; color:white; font-size:24px;">‚úñ</button>
        <h2 style="font-size:28px; color:#fff;">Hurra! üéâ</h2>
        <p style="font-size:20px; color:#ffdd55;">Du hast alle 10 Fragen geschafft!</p>
        <button onclick="restartGame()">Nochmal spielen</button>
      </div>
    </div>
  </div>

<script>
// –ú—É–∑—ã–∫–∞
const bgMusic = document.getElementById("bgMusic");
bgMusic.volume = 0.15;

// –î–∞–Ω–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç–æ–≤
const itemDefinitions = [
  { key:'die_kerze', article:'die', word:'Kerze' },
  { key:'die_glocke', article:'die', word:'Glocke' },
  { key:'der_stern', article:'der', word:'Stern' },
  { key:'die_schneeflocke', article:'die', word:'Schneeflocke' },
  { key:'der_schnee', article:'der', word:'Schnee' },
  { key:'der_weihnachtsbaum', article:'der', word:'Weihnachtsbaum' },
  { key:'das_rendtier', article:'das', word:'Rentier' },
  { key:'der_engel', article:'der', word:'Engel' },
  { key:'der_elf', article:'der', word:'Elf' },
  { key:'der_nikolaus', article:'der', word:'Nikolaus' },
  { key:'der_apfel', article:'der', word:'Apfel' },
  { key:'die_schokolade', article:'die', word:'Schokolade' },
  { key:'die_nuss', article:'die', word:'Nuss' },
  { key:'die_mandarine', article:'die', word:'Mandarine' },
  { key:'das_bonbon', article:'das', word:'Bonbon' },
  { key:'der_schneemann', article:'der', word:'Schneemann' },
  { key:'der_schlitten', article:'der', word:'Schlitten' },
  { key:'die_kugel', article:'die', word:'Kugel' },
  { key:'die_lichter', article:'die', word:'Lichter' },
  { key:'das_geschenk', article:'das', word:'Geschenk' },
  { key:'der_adventskranz', article:'der', word:'Adventskranz' },
  { key:'der_weihnachtsmann', article:'der', word:'Weihnachtsmann' }
];

const TOTAL_QUESTIONS = 10;
const canvas = document.getElementById("gameCanvas");
const snowCanvas = document.getElementById("snow");
const container = document.getElementById("gameContainer");

// –ê–¥–∞–ø—Ç–∏—Ä—É–µ–º canvas –ø–æ–¥ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (—Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–æ–ø–æ—Ä—Ü–∏–∏ 900√ó550)
function resizeCanvas() {
  const width = container.clientWidth;
  const height = container.clientHeight;
  canvas.width = width;
  canvas.height = height;
  snowCanvas.width = width;
  snowCanvas.height = height;

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã –∏–≥—Ä—ã –∫–∞–∫ 900√ó550 –¥–ª—è —Ä–∞—Å—á—ë—Ç–æ–≤
  gameWidth = 900;
  gameHeight = 550;
  scaleX = width / gameWidth;
  scaleY = height / gameHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

const ctx = canvas.getContext("2d");
const snowCtx = snowCanvas.getContext("2d");

let score = 0, misses = 0, caught = 0;
let items = [];
let spawnTimer = 0;
let spawnInterval = 1000;
let gameActive = false;
let inQuiz = false;
let last = 0;

// –õ–æ–≥–∏—á–µ—Å–∫–∏–µ —Ä–∞–∑–º–µ—Ä—ã (–Ω–µ –∑–∞–≤–∏—Å—è—Ç –æ—Ç —ç–∫—Ä–∞–Ω–∞)
const gameWidth = 900;
const gameHeight = 550;
let scaleX = 1, scaleY = 1;

let sack = { x: 400, y: 470, width: 100, height: 80, speed: 400 };

let remainingQuestions = [];
let currentQuestion = null;
let attempts = 0;
let answered = 0;

// –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤
const images = {}, audios = {};
function loadAssets(){
  const sackImg = new Image(); sackImg.src = 'sack.png'; images['sack'] = sackImg;
  itemDefinitions.forEach(i => {
    const im = new Image(); im.src = i.key + '.png'; images[i.key] = im;
  });
  audios['klick'] = new Audio('klick_auf.wav');
  audios['nein'] = new Audio('nein.wav');
  audios['ja'] = new Audio('ja.wav');
  itemDefinitions.forEach(i => audios[i.key] = new Audio(i.key + '.wav'));
}
loadAssets();

// –°–±—Ä–æ—Å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
let touchActive = false;
let startX = 0;

// –°–µ–Ω—Å–æ—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–ª—è –º–µ—à–∫–∞)
canvas.addEventListener("pointerdown", e => {
  touchActive = true;
  const rect = canvas.getBoundingClientRect();
  startX = (e.clientX - rect.left) / scaleX;
  sack.x = startX - sack.width / 2;
});

canvas.addEventListener("pointermove", e => {
  if (!touchActive) return;
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX - rect.left) / scaleX;
  sack.x = x - sack.width / 2;
});

canvas.addEventListener("pointerup", () => { touchActive = false; });
canvas.addEventListener("pointercancel", () => { touchActive = false; });

// –¢–∞–∫–∂–µ –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –ü–ö/–ø–ª–∞–Ω—à–µ—Ç–æ–≤ —Å –∫–ª–∞–≤–æ–π
let left = false, right = false;
document.addEventListener("keydown", e => {
  if (e.key === 'ArrowLeft') left = true;
  if (e.key === 'ArrowRight') right = true;
});
document.addEventListener("keyup", e => {
  if (e.key === 'ArrowLeft') left = false;
  if (e.key === 'ArrowRight') right = false;
});

// –°—Ç–∞—Ä—Ç
document.getElementById("startButton").onclick = () => {
  document.getElementById("startOverlay").classList.add("hidden");
  bgMusic.play().catch(() => {});
  gameActive = true;
};

// –°–Ω–µ–≥ (–∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π)
let snowflakes = Array.from({ length: 120 }, () => ({
  x: Math.random() * gameWidth,
  y: Math.random() * gameHeight,
  r: Math.random() * 3 + 1,
  s: Math.random() * 1 + 0.5
}));

function drawSnow() {
  snowCtx.clearRect(0, 0, snowCanvas.width, snowCanvas.height);
  snowflakes.forEach(f => {
    snowCtx.beginPath();
    snowCtx.arc(f.x * scaleX, f.y * scaleY, f.r, 0, Math.PI * 2);
    snowCtx.fillStyle = "white";
    snowCtx.fill();
    f.y += f.s;
    if (f.y > gameHeight) {
      f.y = -5;
      f.x = Math.random() * gameWidth;
    }
  });
}

// –ö–≤–∏–∑
function startQuiz() {
  inQuiz = true;
  currentQuestion = remainingQuestions.shift();
  attempts = 0;
  document.getElementById("quizTitle").textContent =
    currentQuestion.key === 'die_lichter'
      ? 'Wo sind die Lichter?'
      : `Wo ist ${currentQuestion.article} ${currentQuestion.word}?`;

  const options = [currentQuestion];
  const others = itemDefinitions.filter(x => x.key !== currentQuestion.key);
  shuffle(others);
  options.push(...others.slice(0, 2));
  shuffle(options);

  const box = document.getElementById("quizOptions");
  box.innerHTML = "";
  options.forEach(opt => {
    const btn = document.createElement("div");
    btn.className = "quiz-card";
    btn.dataset.key = opt.key;
    btn.innerHTML = `<img src="${opt.key}.png" style="width:100%;"><div>${opt.article} ${opt.word}</div>`;
    box.appendChild(btn);
  });

  document.getElementById("quizOverlay").classList.remove("hidden");
  stopAllAudio();
  audios[currentQuestion.key].play().catch(() => {});
}

function stopAllAudio() {
  for (const a of Object.values(audios)) {
    a.pause(); a.currentTime = 0;
  }
}

document.getElementById("quizOptions").addEventListener("click", e => {
  const card = e.target.closest('.quiz-card');
  if (!card || !currentQuestion) return;
  const chosen = card.dataset.key.trim();
  const correct = currentQuestion.key.trim();
  if (chosen === correct) {
    let bonus = attempts === 0 ? 3 : attempts === 1 ? 2 : 1;
    score += bonus;
    answered++;
    stopAllAudio();
    audios['ja'].play().catch(() => {});
    document.getElementById("quizOverlay").classList.add("hidden");
    inQuiz = false;
    currentQuestion = null;
    updateHUD();
    if (answered >= TOTAL_QUESTIONS) showCongrats();
  } else {
    attempts++;
    stopAllAudio();
    audios['nein'].play().catch(() => {});
  }
});

// –ö–æ–Ω–µ—Ü –∏–≥—Ä—ã
function endGame() {
  gameActive = false;
  document.getElementById("finalScore").textContent = score;
  document.getElementById("gameOverOverlay").classList.remove("hidden");
}
function restartGame() { location.reload(); }
function showCongrats() {
  document.getElementById("congratsOverlay").classList.remove("hidden");
}

// –ò–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
function shuffle(a) {
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

function spawn() {
  const def = itemDefinitions[Math.floor(Math.random() * itemDefinitions.length)];
  items.push({
    key: def.key,
    x: Math.random() * (gameWidth - 60),
    y: -60,
    width: 60,
    height: 60,
    speed: 120 + Math.random() * 80
  });
}

function updateHUD() {
  document.getElementById("score").textContent = score;
  document.getElementById("misses").textContent = misses;
  document.getElementById("quiz-progress").textContent = answered;
}

function update(dt) {
  if (!gameActive || inQuiz) return;

  // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–æ–µ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ (–¥–ª—è –ø–ª–∞–Ω—à–µ—Ç–æ–≤ —Å –∫–ª–∞–≤–æ–π)
  if (left) sack.x -= sack.speed * dt;
  if (right) sack.x += sack.speed * dt;

  // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –ø–æ –∫—Ä–∞—è–º (–≤ –ª–æ–≥–∏—á–µ—Å–∫–∏—Ö –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞—Ö)
  if (sack.x < 0) sack.x = 0;
  if (sack.x + sack.width > gameWidth) sack.x = gameWidth - sack.width;

  spawnTimer += dt * 1000;
  if (spawnTimer > spawnInterval) {
    spawn();
    spawnTimer = 0;
  }

  let remain = [];
  for (const it of items) {
    it.y += it.speed * dt;
    if (checkColl(it, sack)) {
      score++; caught++; misses = 0;
      if (caught % 5 === 0 && remainingQuestions.length > 0) startQuiz();
      continue;
    }
    if (it.y > gameHeight + 10) {
      misses++;
      if (misses >= 3) endGame();
      continue;
    }
    remain.push(it);
  }
  items = remain;
  updateHUD();
}

function checkColl(a, b) {
  return a.x < b.x + b.width && a.x + a.width > b.x && a.y < b.y + b.height && a.y + a.height > b.y;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  items.forEach(it => {
    ctx.drawImage(images[it.key], it.x * scaleX, it.y * scaleY, it.width * scaleX, it.height * scaleY);
  });
  ctx.drawImage(images['sack'], sack.x * scaleX, sack.y * scaleY, sack.width * scaleX, sack.height * scaleY);
  drawSnow();
}

function loop(t) {
  if (!last) last = t;
  let dt = (t - last) / 1000;
  last = t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
remainingQuestions = shuffle([...itemDefinitions]).slice(0, TOTAL_QUESTIONS);
updateHUD();
</script>
</body>
</html>
